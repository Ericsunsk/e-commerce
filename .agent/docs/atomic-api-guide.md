# Stripe è®¢å•å¤„ç†å·¥ä½œæµæŒ‡å—

æœ¬æ–‡æ¡£è¯´æ˜ Stripe è®¢å•å¤„ç†å·¥ä½œæµçš„æ¶æ„è®¾è®¡å’Œä½¿ç”¨æ–¹å¼ã€‚

## ğŸ“ æ¶æ„æ¦‚è§ˆ

```
Stripe Webhook
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    n8n å·¥ä½œæµ                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ éªŒè¯ç­¾å â”‚â†’â”‚ åˆ›å»ºè®¢å• â”‚â†’â”‚ åŸå­æ“ä½œ â”‚â†’â”‚ å‘é€é‚®ä»¶ â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                                 â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   SvelteKit åŸå­ API   â”‚
                    â”‚  /api/inventory/deduct â”‚
                    â”‚  /api/coupons/incrementâ”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
                                â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚      PocketBase        â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“ æ–‡ä»¶ç»“æ„

```
e-commerce/
â”œâ”€â”€ src/routes/api/
â”‚   â”œâ”€â”€ inventory/deduct/+server.ts       # åŸå­åº“å­˜æ‰£å‡ API
â”‚   â””â”€â”€ coupons/increment/+server.ts      # åŸå­ä¼˜æƒ åˆ¸é€’å¢ API
â””â”€â”€ .agent/docs/atomic-api-guide.md       # æœ¬æ–‡æ¡£
```

---

## ğŸ”Œ API ç«¯ç‚¹

### 1. åº“å­˜åŸå­æ‰£å‡ - `POST /api/inventory/deduct`

**è¯·æ±‚**:
```bash
curl -X POST https://elementhic.com/api/inventory/deduct \
  -H "X-Webhook-Secret: <WEBHOOK_SECRET>" \
  -H "Content-Type: application/json" \
  -d '{
    "orderId": "order_id",
    "items": [
      {"productId": "xxx", "variantId": null, "quantity": 1}
    ]
  }'
```

**è¯·æ±‚çº¦æŸ**:
- å½“ä¸€ä¸ª `productId` å¯¹åº”å¤šä¸ªå˜ä½“æ—¶ï¼Œ`variantId` å¿…å¡«ï¼›å¦åˆ™æ¥å£ä¼šè¿”å›å¤±è´¥å¹¶è¦æ±‚æ˜¾å¼ä¼ å…¥å˜ä½“ã€‚
- æ¥å£æ‰§è¡Œçš„æ˜¯â€œæ ¡éªŒåæ‰£å‡â€è¯­ä¹‰ï¼šåº“å­˜ä¸è¶³ä¼šè¿”å›å¤±è´¥ï¼Œä¸ä¼šå†™å…¥ã€‚

**å“åº”**:
```json
{
  "success": true,
  "orderId": "order_id",
  "results": [
    {
      "productId": "xxx",
      "variantId": null,
      "success": true,
      "previousStock": 10,
      "newStock": 9
    }
  ],
  "processedAt": "2026-02-04T08:30:00.000Z"
}
```

**å®ç°å¯¹é½ï¼ˆå½“å‰ï¼‰**:
- åº“å­˜å†™å…¥ä»…æ›´æ–° `product_variants.stock_quantity`ã€‚
- `stock_status` ä¸å†è½åº“ï¼ˆè¿è¡Œæ—¶æŒ‰ `stock_quantity` è®¡ç®—ï¼‰ã€‚

### 2. ä¼˜æƒ åˆ¸åŸå­é€’å¢ - `POST /api/coupons/increment`

**è¯·æ±‚**:
```bash
curl -X POST https://elementhic.com/api/coupons/increment \
  -H "X-Webhook-Secret: <WEBHOOK_SECRET>" \
  -H "Content-Type: application/json" \
  -d '{"couponCode": "SAVE10", "orderId": "order_id"}'
```

**å“åº”**:
```json
{
  "success": true,
  "couponCode": "SAVE10",
  "previousUsage": 5,
  "newUsage": 6,
  "usageLimit": 100,
  "processedAt": "2026-02-04T08:30:00.000Z"
}
```

---

## âš™ï¸ n8n å·¥ä½œæµé…ç½®

### å¯¼å…¥æ­¥éª¤
1. æ‰“å¼€ n8n
2. è¿›å…¥å·²ä¸Šä¼ çš„è®¢å•å·¥ä½œæµï¼ˆ`Elementhic Stripe Order`ï¼‰
3. ä¿®æ”¹ **âš™ï¸ Config** èŠ‚ç‚¹ä¸­çš„é…ç½®å€¼

### é…ç½®é¡¹
| å˜é‡ | è¯´æ˜ |
|------|------|
| `POCKETBASE_URL` | PocketBase åœ°å€ |
| `SVELTEKIT_URL` | SvelteKit åº”ç”¨åœ°å€ï¼ˆåŸå­ APIï¼‰ |
| `WEBHOOK_SECRET` | å†…éƒ¨è®¤è¯å¯†é’¥ |
| `STRIPE_WEBHOOK_SECRET` | Stripe Webhook å¯†é’¥ |
| `RESEND_API_KEY` | Resend é‚®ä»¶æœåŠ¡å¯†é’¥ |
| `EMAIL_FROM` | å‘ä»¶äººåœ°å€ |
| `SITE_NAME` | ç«™ç‚¹åç§° |

---

## ğŸ”„ çŠ¶æ€è¿½è¸ª (order_meta)

æ¯ä¸ªè®¢å•çš„ `notes` å­—æ®µå­˜å‚¨ JSON æ ¼å¼çš„å¤„ç†çŠ¶æ€ï¼š

```json
{
  "schema": "v2",
  "steps": {
    "stock": true,
    "coupon": true,
    "email": true
  },
  "ts": {
    "created": "2026-02-04T08:00:00.000Z",
    "stock": "2026-02-04T08:00:01.000Z",
    "coupon": "2026-02-04T08:00:02.000Z",
    "email": "2026-02-04T08:00:03.000Z"
  }
}
```

### å¹‚ç­‰æ€§ä¿è¯
- å·¥ä½œæµæ£€æŸ¥ `steps.stock/coupon/email` çŠ¶æ€
- å·²å®Œæˆçš„æ­¥éª¤ä¼šè¢«è·³è¿‡
- Stripe é‡å‘ webhook æ—¶è‡ªåŠ¨è¡¥è·‘æœªå®Œæˆæ­¥éª¤

---

## ğŸ§© æ•°æ®æ¨¡å‹å¯¹é½ï¼ˆ2026-02-24ï¼‰

- å•†å“ä»·æ ¼æ¥æºç»Ÿä¸€ä¸º `products`ï¼ˆStripe æ˜ å°„ä»·æ ¼ï¼‰ã€‚
- `product_variants.price_override` å·²ç§»é™¤ï¼Œå·¥ä½œæµä¸ API ä¸åº”ä¾èµ–å˜ä½“è¦†ç›–ä»·ã€‚
- `product_variants.gallery_images` ä¸ `products.attributes` ä¿ç•™ï¼Œç”¨äºå•†å“å±•ç¤ºä¸è¯¦æƒ…å†…å®¹ã€‚

---

## ğŸ›¡ï¸ å®‰å…¨ç‰¹æ€§

1. **Stripe ç­¾åéªŒè¯**: HMAC-SHA256 + 5 åˆ†é’Ÿæ—¶é—´çª—å£
2. **å†…éƒ¨ API è®¤è¯**: X-Webhook-Secret è¯·æ±‚å¤´
3. **åŸå­æ“ä½œ**: åº“å­˜æ£€æŸ¥åæ‰æ‰£å‡ï¼Œé˜²æ­¢è¶…å–
4. **é‡è¯•æœºåˆ¶**: æ‰€æœ‰ HTTP è¯·æ±‚æ”¯æŒè‡ªåŠ¨é‡è¯•

---

## ğŸš€ éƒ¨ç½²æ¸…å•

- [ ] éƒ¨ç½² SvelteKit åº”ç”¨ï¼ˆåŒ…å«åŸå­ APIï¼‰
- [ ] æ·»åŠ ç¯å¢ƒå˜é‡ `N8N_WEBHOOK_SECRET`
- [ ] å¯¼å…¥ n8n å·¥ä½œæµ
- [ ] é…ç½® âš™ï¸ Config èŠ‚ç‚¹
- [ ] åœ¨ Stripe Dashboard æ·»åŠ  Webhook ç«¯ç‚¹
- [ ] æ¿€æ´»å·¥ä½œæµ
- [ ] æµ‹è¯•è®¢å•æµç¨‹

{
	"name": "Stripe Order Complete - Create Order, Clear Cart & Send Email",
	"nodes": [
		{
			"parameters": {},
			"id": "sticky-intro",
			"name": "ğŸ“‹ Workflow è¯´æ˜",
			"type": "n8n-nodes-base.stickyNote",
			"typeVersion": 1,
			"position": [-400, -100],
			"parameters": {
				"content": "## ğŸ›’ Stripe è®¢å•å®Œæ•´æµç¨‹\n\n**åŠŸèƒ½**: æ”¯ä»˜æˆåŠŸåè‡ªåŠ¨åˆ›å»ºè®¢å•ã€æ¸…ç©ºè´­ç‰©è½¦ã€å‘é€ç¡®è®¤é‚®ä»¶\n\n**è§¦å‘æ¡ä»¶**: Stripe `payment_intent.succeeded` äº‹ä»¶\n\n**Webhook URL**: `/webhook/stripe-order-webhook`\n\n---\n\n### ğŸ”§ é…ç½®è¦ç‚¹\n1. åœ¨ Stripe Dashboard æ·»åŠ  Webhook ç«¯ç‚¹\n2. é€‰æ‹©äº‹ä»¶: `payment_intent.succeeded`\n3. åœ¨ âš™ï¸ Global Config èŠ‚ç‚¹ä¸­é…ç½®æ‰€æœ‰å¯†é’¥\n\n### ï¿½ é¦–æ¬¡ä½¿ç”¨\nè¯·å…ˆä¿®æ”¹ Global Config èŠ‚ç‚¹ä¸­çš„é…ç½®å€¼",
				"width": 360,
				"height": 380,
				"color": 7
			}
		},
		{
			"parameters": {},
			"id": "sticky-config",
			"name": "âš™ï¸ é…ç½®åŒºåŸŸ",
			"type": "n8n-nodes-base.stickyNote",
			"typeVersion": 1,
			"position": [-30, -100],
			"parameters": {
				"content": "## âš™ï¸ å…¨å±€é…ç½®\n\n**åœ¨ä¸‹æ–¹èŠ‚ç‚¹ä¸­ä¿®æ”¹æ‰€æœ‰é…ç½®å€¼**\n\nåŒ…å«:\n- PocketBase URL å’Œå¯†é’¥\n- Resend API Key\n- å‘ä»¶äººä¿¡æ¯\n- ç«™ç‚¹åç§°",
				"width": 280,
				"height": 140,
				"color": 6
			}
		},
		{
			"parameters": {
				"jsCode": "// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// âš™ï¸ å…¨å±€é…ç½® - è¯·åœ¨æ­¤å¤„ä¿®æ”¹æ‰€æœ‰é…ç½®å€¼\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nconst CONFIG = {\n  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n  // ğŸ—„ï¸ PocketBase é…ç½®\n  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n  POCKETBASE_URL: 'https://pb.elementhic.com',\n  POCKETBASE_WEBHOOK_SECRET: 'n8n-elementhic-webhook-2026',\n  \n  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n  // ğŸ“§ Resend é‚®ä»¶é…ç½®\n  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n  RESEND_API_KEY: 're_WwoKz4V7_6FqvneFKgZ1r5ARCpQtPJqMN',\n  EMAIL_FROM_NAME: 'ELEMENTHIC',\n  EMAIL_FROM_ADDRESS: 'orders@elementhic.com',\n  \n  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n  // ğŸª ç«™ç‚¹é…ç½®\n  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n  SITE_NAME: 'ELEMENTHIC',\n  DEFAULT_CURRENCY: 'USD',\n  \n  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n  // ğŸ”— API ç«¯ç‚¹ (åŸºäº PocketBase URL è‡ªåŠ¨ç”Ÿæˆ)\n  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n  get ORDERS_API() {\n    return `${this.POCKETBASE_URL}/api/collections/orders/records`;\n  },\n  get USER_LISTS_API() {\n    return `${this.POCKETBASE_URL}/api/collections/user_lists/records`;\n  },\n  get EMAIL_FROM() {\n    return `${this.EMAIL_FROM_NAME} <${this.EMAIL_FROM_ADDRESS}>`;\n  }\n};\n\n// è¾“å‡ºé…ç½®ä¾›åç»­èŠ‚ç‚¹ä½¿ç”¨\nreturn {\n  json: {\n    config: CONFIG,\n    // å±•å¼€å¸¸ç”¨å€¼æ–¹ä¾¿ç›´æ¥å¼•ç”¨\n    pocketbase_url: CONFIG.POCKETBASE_URL,\n    webhook_secret: CONFIG.POCKETBASE_WEBHOOK_SECRET,\n    orders_api: CONFIG.ORDERS_API,\n    user_lists_api: CONFIG.USER_LISTS_API,\n    resend_api_key: CONFIG.RESEND_API_KEY,\n    email_from: CONFIG.EMAIL_FROM,\n    site_name: CONFIG.SITE_NAME,\n    default_currency: CONFIG.DEFAULT_CURRENCY\n  }\n};"
			},
			"id": "global-config",
			"name": "âš™ï¸ Global Config",
			"type": "n8n-nodes-base.code",
			"typeVersion": 2,
			"position": [0, 100],
			"notes": "âš™ï¸ å…¨å±€é…ç½®èŠ‚ç‚¹\n\nğŸ“Œ è¯·åœ¨æ­¤å¤„ä¿®æ”¹æ‰€æœ‰é…ç½®å€¼:\n\nğŸ—„ï¸ PocketBase:\n- POCKETBASE_URL: APIåœ°å€\n- POCKETBASE_WEBHOOK_SECRET: è®¤è¯å¯†é’¥\n\nğŸ“§ Resend:\n- RESEND_API_KEY: APIå¯†é’¥\n- EMAIL_FROM_*: å‘ä»¶äººä¿¡æ¯\n\nğŸª ç«™ç‚¹:\n- SITE_NAME: ç«™ç‚¹åç§°\n- DEFAULT_CURRENCY: é»˜è®¤è´§å¸"
		},
		{
			"parameters": {},
			"id": "sticky-trigger",
			"name": "ğŸŸ¢ è§¦å‘å™¨åŒºåŸŸ",
			"type": "n8n-nodes-base.stickyNote",
			"typeVersion": 1,
			"position": [220, 80],
			"parameters": {
				"content": "## ğŸŸ¢ ç¬¬1æ­¥: æ¥æ”¶ Webhook\n\næ¥æ”¶ Stripe å‘æ¥çš„æ”¯ä»˜æˆåŠŸäº‹ä»¶\n\nâš ï¸ å¿…é¡»ç«‹å³è¿”å› 200ï¼Œå¦åˆ™ Stripe ä¼šè¶…æ—¶é‡è¯•",
				"width": 280,
				"height": 140,
				"color": 3
			}
		},
		{
			"parameters": {},
			"id": "sticky-parse",
			"name": "ğŸ”µ è§£æåŒºåŸŸ",
			"type": "n8n-nodes-base.stickyNote",
			"typeVersion": 1,
			"position": [450, 220],
			"parameters": {
				"content": "## ğŸ”µ ç¬¬2æ­¥: è§£æè®¢å•æ•°æ®\n\nä» PaymentIntent.metadata.order_data ä¸­æå–:\n- ç”¨æˆ·ä¿¡æ¯\n- å•†å“åˆ—è¡¨\n- é‡‘é¢æ˜ç»†\n- æ”¶è´§åœ°å€",
				"width": 280,
				"height": 160,
				"color": 1
			}
		},
		{
			"parameters": {},
			"id": "sticky-order",
			"name": "ğŸŸ£ è®¢å•åˆ›å»ºåŒºåŸŸ",
			"type": "n8n-nodes-base.stickyNote",
			"typeVersion": 1,
			"position": [870, 80],
			"parameters": {
				"content": "## ğŸŸ£ ç¬¬3æ­¥: åˆ›å»ºè®¢å•\n\nè°ƒç”¨ PocketBase API åˆ›å»ºè®¢å•è®°å½•\n\n**è®¤è¯**: X-Webhook-Secret header\n**çŠ¶æ€**: paid",
				"width": 300,
				"height": 140,
				"color": 5
			}
		},
		{
			"parameters": {},
			"id": "sticky-cart",
			"name": "ğŸŸ¡ è´­ç‰©è½¦æ¸…ç©ºåŒºåŸŸ",
			"type": "n8n-nodes-base.stickyNote",
			"typeVersion": 1,
			"position": [1320, -30],
			"parameters": {
				"content": "## ğŸŸ¡ ç¬¬4æ­¥: æ¸…ç©ºè´­ç‰©è½¦\n\nå¦‚æœæ˜¯ç™»å½•ç”¨æˆ·ï¼ŒæŸ¥æ‰¾å¹¶åˆ é™¤å…¶è´­ç‰©è½¦\n\n1. æ£€æŸ¥æ˜¯å¦æœ‰ user_id\n2. æŸ¥è¯¢ user_lists ä¸­çš„ cart\n3. åˆ é™¤è´­ç‰©è½¦è®°å½•",
				"width": 320,
				"height": 160,
				"color": 4
			}
		},
		{
			"parameters": {},
			"id": "sticky-email",
			"name": "ğŸ”´ é‚®ä»¶å‘é€åŒºåŸŸ",
			"type": "n8n-nodes-base.stickyNote",
			"typeVersion": 1,
			"position": [1970, 80],
			"parameters": {
				"content": "## ğŸ”´ ç¬¬5æ­¥: å‘é€ç¡®è®¤é‚®ä»¶\n\nä½¿ç”¨ Resend API å‘é€è®¢å•ç¡®è®¤é‚®ä»¶\n\n**å‘ä»¶äºº**: ä» Global Config è¯»å–\n**æ¨¡æ¿**: è‡ªåŠ¨ç”Ÿæˆ HTML æ”¶æ®",
				"width": 300,
				"height": 140,
				"color": 2
			}
		},
		{
			"parameters": {
				"httpMethod": "POST",
				"path": "stripe-order-webhook",
				"responseMode": "responseNode",
				"options": {}
			},
			"id": "webhook-trigger",
			"name": "Stripe Webhook",
			"type": "n8n-nodes-base.webhook",
			"typeVersion": 2,
			"position": [270, 300],
			"webhookId": "stripe-order-webhook",
			"notes": "ğŸŸ¢ æ¥æ”¶ Stripe payment_intent.succeeded äº‹ä»¶\n\nWebhook URL: /webhook/stripe-order-webhook\n\né…ç½®æç¤º:\n1. åœ¨ Stripe Dashboard æ·»åŠ æ­¤ URL\n2. é€‰æ‹©äº‹ä»¶ payment_intent.succeeded\n3. API ç‰ˆæœ¬é€‰æ‹© Latest"
		},
		{
			"parameters": {
				"respondWith": "json",
				"responseBody": "={\"received\": true}",
				"options": {}
			},
			"id": "respond-immediately",
			"name": "Respond 200",
			"type": "n8n-nodes-base.respondToWebhook",
			"typeVersion": 1.1,
			"position": [490, 160],
			"notes": "ğŸŸ¢ ç«‹å³è¿”å› 200 å“åº”\n\nâš ï¸ é‡è¦: å¿…é¡»å¿«é€Ÿå“åº”ï¼Œå¦åˆ™ Stripe ä¼šè¶…æ—¶å¹¶é‡è¯•å‘é€ webhook"
		},
		{
			"parameters": {
				"jsCode": "// Parse Stripe webhook payload\nconst config = $node['âš™ï¸ Global Config'].json;\nconst body = $('Stripe Webhook').item.json.body;\n\n// Validate event type\nif (body.type !== 'payment_intent.succeeded') {\n  return [{ json: { skip: true, reason: 'Not payment_intent.succeeded', config } }];\n}\n\nconst paymentIntent = body.data.object;\nconst metadata = paymentIntent.metadata || {};\n\n// Parse order data from metadata\nlet orderData = {};\ntry {\n  orderData = JSON.parse(metadata.order_data || '{}');\n} catch (e) {\n  console.log('Failed to parse order_data:', e.message);\n}\n\nreturn [{\n  json: {\n    skip: false,\n    config,  // ä¼ é€’é…ç½®ç»™åç»­èŠ‚ç‚¹\n    payment_intent_id: paymentIntent.id,\n    customer_id: paymentIntent.customer || null,\n    stripe_amount: paymentIntent.amount,\n    stripe_currency: paymentIntent.currency,\n    \n    // Order data from metadata\n    user_id: orderData.user_id || metadata.user_id || '',\n    customer_email: orderData.customer_email || paymentIntent.receipt_email || '',\n    customer_name: orderData.customer_name || 'Guest',\n    items: orderData.items || [],\n    amount_subtotal: orderData.amount_subtotal || paymentIntent.amount,\n    amount_shipping: orderData.amount_shipping || 0,\n    amount_tax: orderData.amount_tax || 0,\n    amount_total: orderData.amount_total || paymentIntent.amount,\n    currency: orderData.currency || paymentIntent.currency || 'usd',\n    shipping_address: orderData.shipping_address || {},\n    coupon_code: orderData.coupon_code || metadata.coupon_code || ''\n  }\n}];"
			},
			"id": "parse-order-data",
			"name": "Parse Order Data",
			"type": "n8n-nodes-base.code",
			"typeVersion": 2,
			"position": [490, 300],
			"notes": "ğŸ”µ è§£æè®¢å•æ•°æ®\n\nä» PaymentIntent.metadata.order_data (JSON) ä¸­æå–:\n- payment_intent_id: Stripe æ”¯ä»˜ ID\n- user_id: PocketBase ç”¨æˆ· ID\n- customer_email: å®¢æˆ·é‚®ç®±\n- items: å•†å“åˆ—è¡¨\n- amount_total: æ€»é‡‘é¢ (åˆ†)\n- shipping_address: æ”¶è´§åœ°å€\n\nåŒæ—¶ä¼ é€’ config ç»™åç»­èŠ‚ç‚¹"
		},
		{
			"parameters": {
				"conditions": {
					"options": {
						"caseSensitive": true,
						"leftValue": "",
						"typeValidation": "strict"
					},
					"conditions": [
						{
							"id": "check-skip",
							"leftValue": "={{ $json.skip }}",
							"rightValue": false,
							"operator": {
								"type": "boolean",
								"operation": "equals"
							}
						}
					],
					"combinator": "and"
				},
				"options": {}
			},
			"id": "if-not-skip",
			"name": "Should Process?",
			"type": "n8n-nodes-base.if",
			"typeVersion": 2,
			"position": [710, 300],
			"notes": "ğŸ”µ æ£€æŸ¥æ˜¯å¦éœ€è¦å¤„ç†\n\nå¦‚æœäº‹ä»¶ç±»å‹ä¸æ˜¯ payment_intent.succeededï¼Œåˆ™è·³è¿‡"
		},
		{
			"parameters": {
				"method": "POST",
				"url": "={{ $node['âš™ï¸ Global Config'].json.orders_api }}",
				"sendHeaders": true,
				"headerParameters": {
					"parameters": [
						{
							"name": "X-Webhook-Secret",
							"value": "={{ $node['âš™ï¸ Global Config'].json.webhook_secret }}"
						}
					]
				},
				"sendBody": true,
				"specifyBody": "json",
				"jsonBody": "={\n  \"user\": {{ $node['Parse Order Data'].json.user_id ? '\"' + $node['Parse Order Data'].json.user_id + '\"' : 'null' }},\n  \"stripe_payment_intent\": \"{{ $node['Parse Order Data'].json.payment_intent_id }}\",\n  \"customer_email\": \"{{ $node['Parse Order Data'].json.customer_email }}\",\n  \"customer_name\": \"{{ $node['Parse Order Data'].json.customer_name }}\",\n  \"items\": {{ JSON.stringify($node['Parse Order Data'].json.items) }},\n  \"amount_subtotal\": {{ $node['Parse Order Data'].json.amount_subtotal }},\n  \"amount_shipping\": {{ $node['Parse Order Data'].json.amount_shipping }},\n  \"amount_tax\": {{ $node['Parse Order Data'].json.amount_tax }},\n  \"amount_total\": {{ $node['Parse Order Data'].json.amount_total }},\n  \"currency\": \"{{ $node['Parse Order Data'].json.currency }}\",\n  \"status\": \"paid\",\n  \"shipping_address\": {{ JSON.stringify($node['Parse Order Data'].json.shipping_address) }}\n}",
				"options": {}
			},
			"id": "create-order",
			"name": "Create Order",
			"type": "n8n-nodes-base.httpRequest",
			"typeVersion": 4.2,
			"position": [930, 200],
			"notes": "ğŸŸ£ åˆ›å»ºè®¢å•åˆ° PocketBase\n\nAPI URL: ä» Global Config è¯»å–\nè®¤è¯: X-Webhook-Secret (ä» Config è¯»å–)\n\nå­—æ®µ:\n- user: ç”¨æˆ· ID (å¯é€‰)\n- stripe_payment_intent: Stripe ID\n- items: å•†å“å¿«ç…§ (JSON)\n- amount_*: é‡‘é¢æ˜ç»†\n- status: paid"
		},
		{
			"parameters": {
				"conditions": {
					"options": {
						"caseSensitive": true,
						"leftValue": "",
						"typeValidation": "strict"
					},
					"conditions": [
						{
							"id": "has-user-id",
							"leftValue": "={{ $node['Parse Order Data'].json.user_id }}",
							"rightValue": "",
							"operator": {
								"type": "string",
								"operation": "notEmpty"
							}
						}
					],
					"combinator": "and"
				},
				"options": {}
			},
			"id": "if-has-user",
			"name": "Has User ID?",
			"type": "n8n-nodes-base.if",
			"typeVersion": 2,
			"position": [1150, 200],
			"notes": "ğŸŸ¡ æ£€æŸ¥æ˜¯å¦ä¸ºç™»å½•ç”¨æˆ·\n\nå¦‚æœæœ‰ user_idï¼Œåˆ™éœ€è¦æ¸…ç©ºè´­ç‰©è½¦\nå¦‚æœæ²¡æœ‰ (Guest)ï¼Œç›´æ¥è·³åˆ°å‘é‚®ä»¶"
		},
		{
			"parameters": {
				"method": "GET",
				"url": "={{ $node['âš™ï¸ Global Config'].json.user_lists_api }}?filter=(user='{{ $node['Parse Order Data'].json.user_id }}' %26%26 type='cart')",
				"sendHeaders": true,
				"headerParameters": {
					"parameters": [
						{
							"name": "X-Webhook-Secret",
							"value": "={{ $node['âš™ï¸ Global Config'].json.webhook_secret }}"
						}
					]
				},
				"options": {}
			},
			"id": "find-cart",
			"name": "Find User Cart",
			"type": "n8n-nodes-base.httpRequest",
			"typeVersion": 4.2,
			"position": [1370, 100],
			"notes": "ğŸŸ¡ æŸ¥æ‰¾ç”¨æˆ·è´­ç‰©è½¦\n\nAPI URL: ä» Global Config è¯»å–\n\næŸ¥è¯¢æ¡ä»¶:\n- user = ç”¨æˆ·ID\n- type = 'cart'\n\næ³¨æ„: filter ä¸­çš„ && éœ€è¦ç¼–ç ä¸º %26%26"
		},
		{
			"parameters": {
				"conditions": {
					"options": {
						"caseSensitive": true,
						"leftValue": "",
						"typeValidation": "strict"
					},
					"conditions": [
						{
							"id": "cart-exists",
							"leftValue": "={{ $json.totalItems }}",
							"rightValue": 0,
							"operator": {
								"type": "number",
								"operation": "gt"
							}
						}
					],
					"combinator": "and"
				},
				"options": {}
			},
			"id": "if-cart-exists",
			"name": "Cart Exists?",
			"type": "n8n-nodes-base.if",
			"typeVersion": 2,
			"position": [1590, 100],
			"notes": "ğŸŸ¡ æ£€æŸ¥è´­ç‰©è½¦æ˜¯å¦å­˜åœ¨\n\nå¦‚æœ totalItems > 0ï¼Œåˆ™æœ‰è´­ç‰©è½¦éœ€è¦åˆ é™¤"
		},
		{
			"parameters": {
				"method": "DELETE",
				"url": "={{ $node['âš™ï¸ Global Config'].json.user_lists_api }}/{{ $json.items[0].id }}",
				"sendHeaders": true,
				"headerParameters": {
					"parameters": [
						{
							"name": "X-Webhook-Secret",
							"value": "={{ $node['âš™ï¸ Global Config'].json.webhook_secret }}"
						}
					]
				},
				"options": {}
			},
			"id": "delete-cart",
			"name": "Delete Cart",
			"type": "n8n-nodes-base.httpRequest",
			"typeVersion": 4.2,
			"position": [1810, 0],
			"notes": "ğŸŸ¡ åˆ é™¤è´­ç‰©è½¦\n\nAPI URL: ä» Global Config è¯»å–\n\nåˆ é™¤æ‰¾åˆ°çš„ç¬¬ä¸€ä¸ªè´­ç‰©è½¦è®°å½•"
		},
		{
			"parameters": {
				"jsCode": "// Generate HTML Receipt for Email\nconst orderData = $node['Parse Order Data'].json;\nconst config = $node['âš™ï¸ Global Config'].json;\nconst createdOrder = $node['Create Order'].json;\nconst siteName = config.site_name || 'ELEMENTHIC';\nconst currency = (orderData.currency || config.default_currency || 'USD').toUpperCase();\n\n// Format Currency\nconst formatPrice = (amount) => {\n  return new Intl.NumberFormat('en-US', {\n    style: 'currency',\n    currency: currency\n  }).format(amount / 100);\n};\n\n// Generate Items HTML\nconst items = orderData.items || [];\nconst itemsHtml = items.map(item => `\n  <div style=\"border-bottom: 1px solid #eee; padding: 10px 0; display: flex; align-items: center;\">\n    <div style=\"flex-grow: 1;\">\n      <p style=\"margin: 0; font-weight: bold; color: #333;\">${item.title}</p>\n      <p style=\"margin: 0; font-size: 12px; color: #666;\">\n        Quantity: ${item.quantity} \n        ${item.size ? `| Size: ${item.size}` : ''} \n        ${item.color ? `| Color: ${item.color}` : ''}\n      </p>\n    </div>\n    <div style=\"font-weight: bold; color: #333;\">\n      ${formatPrice((item.price || 0) * (item.quantity || 1))}\n    </div>\n  </div>\n`).join('');\n\nconst shippingAddress = orderData.shipping_address || {};\nconst orderId = createdOrder.id || 'UNKNOWN';\n\nreturn {\n  json: {\n    order_id: orderId,\n    customer_email: orderData.customer_email,\n    customer_name: orderData.customer_name,\n    amount_total: orderData.amount_total,\n    config,  // ä¼ é€’é…ç½®\n    emailHtml: `\n<!DOCTYPE html>\n<html>\n<head>\n  <style>\n    body { font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif; line-height: 1.6; color: #333; }\n    .container { max-width: 600px; margin: 0 auto; padding: 20px; }\n    .header { text-align: center; border-bottom: 2px solid #000; padding-bottom: 20px; margin-bottom: 30px; }\n    .logo { font-size: 24px; font-weight: bold; letter-spacing: 0.1em; text-transform: uppercase; }\n    .order-details { margin-bottom: 30px; background: #f9f9f9; padding: 20px; border-radius: 5px; }\n    .footer { text-align: center; font-size: 12px; color: #999; margin-top: 50px; border-top: 1px solid #eee; padding-top: 20px; }\n  </style>\n</head>\n<body>\n  <div class=\"container\">\n    <div class=\"header\">\n      <div class=\"logo\">${siteName}</div>\n    </div>\n    \n    <h2>Thank you for your order, ${orderData.customer_name || 'Guest'}!</h2>\n    <p>We received your order and will process it shortly.</p>\n    \n    <div class=\"order-details\">\n      <h3 style=\"margin-top: 0;\">Order #${orderId.slice(-6).toUpperCase()}</h3>\n      <p style=\"margin: 0; color: #666;\">${new Date().toLocaleDateString()}</p>\n    </div>\n\n    <h3>Order Summary</h3>\n    ${itemsHtml}\n\n    <div style=\"margin-top: 20px; text-align: right; font-size: 18px; font-weight: bold;\">\n      Total: ${formatPrice(orderData.amount_total)}\n    </div>\n\n    <div style=\"margin-top: 40px;\">\n      <h3>Shipping Address</h3>\n      <p>\n        ${shippingAddress.name || ''}<br>\n        ${shippingAddress.line1 || ''}<br>\n        ${shippingAddress.city || ''}, ${shippingAddress.state || ''} ${shippingAddress.postalCode || ''}<br>\n        ${shippingAddress.country || ''}\n      </p>\n    </div>\n\n    <div class=\"footer\">\n      <p>&copy; ${new Date().getFullYear()} ${siteName}. All rights reserved.</p>\n    </div>\n  </div>\n</body>\n</html>`\n  }\n};"
			},
			"id": "generate-email",
			"name": "Generate Email HTML",
			"type": "n8n-nodes-base.code",
			"typeVersion": 2,
			"position": [2030, 200],
			"notes": "ğŸ”´ ç”Ÿæˆé‚®ä»¶ HTML\n\nä½¿ç”¨è®¢å•æ•°æ®å’Œ Global Config ç”Ÿæˆ HTML æ”¶æ®\n\nç«™ç‚¹åç§°: ä» Config è¯»å–\nè´§å¸æ ¼å¼: ä» Config è¯»å–"
		},
		{
			"parameters": {
				"method": "POST",
				"url": "https://api.resend.com/emails",
				"sendHeaders": true,
				"headerParameters": {
					"parameters": [
						{
							"name": "Authorization",
							"value": "=Bearer {{ $node['âš™ï¸ Global Config'].json.resend_api_key }}"
						},
						{
							"name": "Content-Type",
							"value": "application/json"
						}
					]
				},
				"sendBody": true,
				"specifyBody": "json",
				"jsonBody": "={\n  \"from\": \"{{ $node['âš™ï¸ Global Config'].json.email_from }}\",\n  \"to\": \"{{ $json.customer_email }}\",\n  \"subject\": \"Order Confirmation #{{ $json.order_id.slice(-6).toUpperCase() }}\",\n  \"html\": {{ JSON.stringify($json.emailHtml) }}\n}",
				"options": {}
			},
			"id": "send-email",
			"name": "Send Email (Resend)",
			"type": "n8n-nodes-base.httpRequest",
			"typeVersion": 4.2,
			"position": [2250, 200],
			"notes": "ğŸ”´ å‘é€ç¡®è®¤é‚®ä»¶\n\nä½¿ç”¨ Resend API å‘é€é‚®ä»¶\n\næ‰€æœ‰é…ç½®ä» Global Config è¯»å–:\n- API Key\n- å‘ä»¶äººåœ°å€"
		},
		{
			"parameters": {
				"values": {
					"string": [
						{
							"name": "status",
							"value": "completed"
						},
						{
							"name": "order_id",
							"value": "={{ $node['Create Order'].json.id }}"
						},
						{
							"name": "email_sent",
							"value": "true"
						},
						{
							"name": "message",
							"value": "Order created, cart cleared, and email sent successfully"
						}
					]
				},
				"options": {}
			},
			"id": "success-output",
			"name": "Success",
			"type": "n8n-nodes-base.set",
			"typeVersion": 3.4,
			"position": [2470, 200],
			"notes": "âœ… æµç¨‹å®Œæˆ\n\næ‰€æœ‰æ­¥éª¤æˆåŠŸæ‰§è¡Œ:\n- è®¢å•å·²åˆ›å»º\n- è´­ç‰©è½¦å·²æ¸…ç©º\n- ç¡®è®¤é‚®ä»¶å·²å‘é€"
		},
		{
			"parameters": {
				"values": {
					"string": [
						{
							"name": "status",
							"value": "skipped"
						},
						{
							"name": "reason",
							"value": "={{ $json.reason || 'Event type not supported' }}"
						}
					]
				},
				"options": {}
			},
			"id": "skip-output",
			"name": "Skipped",
			"type": "n8n-nodes-base.set",
			"typeVersion": 3.4,
			"position": [930, 400],
			"notes": "â­ï¸ è·³è¿‡å¤„ç†\n\näº‹ä»¶ç±»å‹ä¸æ˜¯ payment_intent.succeededï¼Œæ— éœ€å¤„ç†"
		}
	],
	"connections": {
		"âš™ï¸ Global Config": {
			"main": [
				[
					{
						"node": "Stripe Webhook",
						"type": "main",
						"index": 0
					}
				]
			]
		},
		"Stripe Webhook": {
			"main": [
				[
					{
						"node": "Respond 200",
						"type": "main",
						"index": 0
					},
					{
						"node": "Parse Order Data",
						"type": "main",
						"index": 0
					}
				]
			]
		},
		"Parse Order Data": {
			"main": [
				[
					{
						"node": "Should Process?",
						"type": "main",
						"index": 0
					}
				]
			]
		},
		"Should Process?": {
			"main": [
				[
					{
						"node": "Create Order",
						"type": "main",
						"index": 0
					}
				],
				[
					{
						"node": "Skipped",
						"type": "main",
						"index": 0
					}
				]
			]
		},
		"Create Order": {
			"main": [
				[
					{
						"node": "Has User ID?",
						"type": "main",
						"index": 0
					}
				]
			]
		},
		"Has User ID?": {
			"main": [
				[
					{
						"node": "Find User Cart",
						"type": "main",
						"index": 0
					}
				],
				[
					{
						"node": "Generate Email HTML",
						"type": "main",
						"index": 0
					}
				]
			]
		},
		"Find User Cart": {
			"main": [
				[
					{
						"node": "Cart Exists?",
						"type": "main",
						"index": 0
					}
				]
			]
		},
		"Cart Exists?": {
			"main": [
				[
					{
						"node": "Delete Cart",
						"type": "main",
						"index": 0
					}
				],
				[
					{
						"node": "Generate Email HTML",
						"type": "main",
						"index": 0
					}
				]
			]
		},
		"Delete Cart": {
			"main": [
				[
					{
						"node": "Generate Email HTML",
						"type": "main",
						"index": 0
					}
				]
			]
		},
		"Generate Email HTML": {
			"main": [
				[
					{
						"node": "Send Email (Resend)",
						"type": "main",
						"index": 0
					}
				]
			]
		},
		"Send Email (Resend)": {
			"main": [
				[
					{
						"node": "Success",
						"type": "main",
						"index": 0
					}
				]
			]
		}
	},
	"settings": {
		"executionOrder": "v1"
	},
	"staticData": null,
	"tags": [
		{
			"name": "stripe",
			"createdAt": "2026-02-01T08:00:00.000Z",
			"updatedAt": "2026-02-01T08:00:00.000Z"
		},
		{
			"name": "pocketbase",
			"createdAt": "2026-02-01T08:00:00.000Z",
			"updatedAt": "2026-02-01T08:00:00.000Z"
		},
		{
			"name": "orders",
			"createdAt": "2026-02-01T08:00:00.000Z",
			"updatedAt": "2026-02-01T08:00:00.000Z"
		},
		{
			"name": "email",
			"createdAt": "2026-02-01T08:00:00.000Z",
			"updatedAt": "2026-02-01T08:00:00.000Z"
		}
	],
	"triggerCount": 1,
	"pinData": {},
	"meta": {
		"templateCredsSetupCompleted": true,
		"instanceId": "elementhic-ecommerce"
	}
}
